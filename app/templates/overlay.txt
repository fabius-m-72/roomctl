<!-- OVERLAY AVVIO/ARRESTO LEZIONE -->
<div id="scene-overlay" class="scene-overlay hidden">
  <div class="scene-overlay-backdrop"></div>

  <div class="scene-overlay-dialog">
    <div class="scene-overlay-title" id="scene-overlay-title">
      Operazione in corso
    </div>
    <div class="scene-status-label" id="scene-status-label">
      Avvio/arresto in corso, attendere…
    </div>
  </div>
</div>


<script>
(function() {
  const MAX_LEN = 4; // porta a 6 se il PIN è a 6 cifre

  // === PIN OVERLAY ===
  const overlay   = document.getElementById('pin-overlay');
  const openBtn   = document.getElementById('open-pin-overlay');
  const cancelBtn = document.getElementById('pin-cancel');
  const pinValue  = document.getElementById('pin-value');
  const pinDots   = document.getElementById('pin-dots');
  const keys      = overlay ? overlay.querySelectorAll('.pin-key') : [];
  const backdrop  = overlay ? overlay.querySelector('.pin-overlay-backdrop') : null;

  function renderDots() {
    if (!pinDots || !pinValue) return;
    const len = (pinValue.value || '').length;
    pinDots.textContent = '●'.repeat(len);
  }

  function clearPin() {
    if (!pinValue) return;
    pinValue.value = '';
    renderDots();
  }

  function addDigit(d) {
    if (!pinValue) return;
    if (pinValue.value.length >= MAX_LEN) return;
    pinValue.value += d;
    renderDots();
  }

  function backspace() {
    if (!pinValue) return;
    pinValue.value = pinValue.value.slice(0, -1);
    renderDots();
  }

  function openPinOverlay() {
    if (!overlay) return;
    clearPin();
    overlay.classList.remove('hidden');
  }

  function closePinOverlay() {
    if (!overlay) return;
    overlay.classList.add('hidden');
    clearPin();
  }

  if (openBtn) {
    openBtn.addEventListener('click', openPinOverlay);
  }
  if (cancelBtn) {
    cancelBtn.addEventListener('click', closePinOverlay);
  }
  if (backdrop) {
    backdrop.addEventListener('click', closePinOverlay);
  }

  keys.forEach(btn => {
    btn.addEventListener('click', () => {
      const key = btn.dataset.key;
      const action = btn.dataset.action;
      if (key !== undefined) {
        addDigit(key);
      } else if (action === 'clear') {
        clearPin();
      } else if (action === 'backspace') {
        backspace();
      }
    });
  });

  document.addEventListener('contextmenu', e => e.preventDefault());

  // valore da Jinja: apre il PIN overlay se c'è stato errore
  const hasPinError = {{ 'true' if pin_error else 'false' }};
  if (hasPinError) {
    openPinOverlay();
  }

  // === OVERLAY AVVIO/ARRESTO LEZIONE ===
  const sceneOverlay       = document.getElementById('scene-overlay');
  const sceneStatusLabel   = document.getElementById('scene-status-label');
  const sceneOverlayTitle  = document.getElementById('scene-overlay-title');

  function openSceneOverlay(initialTitle, initialText) {
    if (!sceneOverlay) return;
    if (sceneOverlayTitle && initialTitle) {
      sceneOverlayTitle.textContent = initialTitle;
    }
    if (sceneStatusLabel && initialText) {
      sceneStatusLabel.textContent = initialText;
    }
    sceneOverlay.classList.remove('hidden');
  }

  // Aggancia tutte le form delle scene
  const sceneForms = document.querySelectorAll('form.scene-form');
  sceneForms.forEach(form => {
    form.addEventListener('submit', () => {
      const action = form.getAttribute('action') || '';
      let title = 'Operazione in corso';
      let text  = 'Avvio/arresto in corso, attendere…';

      if (action.includes('/ui/scene/avvio_semplice')) {
        title = 'Avvio Lezione Semplice';
        text  = 'Avvio lezione semplice in corso, attendere…';
      } else if (action.includes('/ui/scene/avvio_video_combinata')) {
        title = 'Avvio Lezione Video Combinata';
        text  = 'Avvio lezione video combinata in corso, attendere…';
      } else if (action.includes('/ui/scene/avvio_video')) {
        title = 'Avvio Lezione Video';
        text  = 'Avvio lezione video in corso, attendere…';
      } else if (action.includes('/ui/scene/spegni_aula')) {
        title = 'Fine Lezione – Spegni Aula';
        text  = 'Arresto lezione e spegnimento aula in corso, attendere…';
      }

      openSceneOverlay(title, text);
      // NON facciamo preventDefault: il submit continua normalmente,
      // il backend esegue la scena e poi fa redirect alla home,
      // facendo sparire l’overlay al reload.
    });
  });

})();
</script>



.scene-overlay {
  position: fixed;
  inset: 0;
  z-index: 1100;
  display: flex;
  align-items: center;
  justify-content: center;
}

.scene-overlay-backdrop {
  position: absolute;
  inset: 0;
  background: rgba(0, 0, 0, 0.6);
}

.scene-overlay-dialog {
  position: relative;
  background: #111;
  border-radius: 16px;
  padding: 24px 32px;
  min-width: 320px;
  max-width: 480px;
  text-align: center;
  box-shadow: 0 0 20px rgba(0,0,0,0.5);
}

.scene-overlay-title {
  font-size: 1.5rem;
  margin-bottom: 12px;
  font-weight: 600;
}

.scene-status-label {
  font-size: 1.1rem;
}
