{% extends "base.html" %}
{% block content %}
<div class="screen">
  <header class="header">
    <div class="title">ROOMCTL</div>
  </header>

  <main class="main">
    {# lezione attiva: "semplice", "video", "combinata" oppure None #}
    {% set active_lesson = state.current_lesson if state and (state.current_lesson is defined) and state.current_lesson else None %}

    {% if show_combined %}
      <div class="buttons-grid">
        <form method="post" action="/ui/scene/avvio_semplice" class="scene-form">
          <button class="btn btn-green"
                  {% if active_lesson %}disabled{% endif %}>
            Avvio Lezione Semplice{% if active_lesson == 'semplice' %} ...in corso{% endif %}
          </button>
        </form>

        <form method="post" action="/ui/scene/avvio_video" class="scene-form">
          <button class="btn btn-blue"
                  {% if active_lesson %}disabled{% endif %}>
            Avvio Lezione Video{% if active_lesson == 'video' %} ...in corso{% endif %}
          </button>
        </form>

        <form method="post" action="/ui/scene/avvio_video_combinata" class="scene-form">
          <button class="btn btn-ice"
                  {% if active_lesson %}disabled{% endif %}>
            Avvio Lezione<br>Video Combinata{% if active_lesson == 'combinata' %} ...in corso{% endif %}
          </button>
        </form>

        <form method="post" action="/ui/scene/spegni_aula" class="scene-form" >
          <button class="btn btn-sand"
                    {% if not active_lesson %}disabled{% endif %}>
            Fine Lezione – Spegni Aula
          </button>
        </form>
      </div>
    {% else %}
      <div class="buttons-grid">
        <form method="post" action="/ui/scene/avvio_semplice" class="scene-form">
          <button class="btn btn-green"
                  {% if active_lesson %}disabled{% endif %}>
            Avvio Lezione Semplice{% if active_lesson == 'semplice' %} ...in corso{% endif %}
          </button>
        </form>

        <form method="post" action="/ui/scene/avvio_video" class="scene-form">
          <button class="btn btn-blue"
                  {% if active_lesson %}disabled{% endif %}>
            Avvio Lezione Video{% if active_lesson == 'video' %} ...in corso{% endif %}
          </button>
        </form>
      
        <form method="post" action="/ui/scene/spegni_aula" class="btn-span-2" class="scene-form">
          <button class="btn btn-sand btn-span-2"
                {% if not active_lesson %}disabled{% endif %}>
            Fine Lezione – Spegni Aula
          </button>
        </form>
      </div>
    {% endif %}
  </main>

  <footer class="footer">
    <div class="status">Stato: {{ state.text or '' }}</div>
    <div id="badge-input" class="badge">
      Input: {{ (state.projector.input if state.projector else '—') if state else '—' }}
    </div>

    {# Area Operatore sempre abilitato #}
    <button type="button" class="btn-operator" id="open-pin-overlay">
      Area Operatore
    </button>
  </footer>
</div>

{# OVERLAY PIN OPERATORE #}
<div id="pin-overlay" class="pin-overlay hidden">
  <div class="pin-overlay-backdrop"></div>

  <div class="pin-overlay-dialog">
    <div class="pin-overlay-title">Accesso Operatore</div>

    {% if pin_error %}
      <div class="pin-error">PIN non valido. Riprova.</div>
    {% endif %}

    <form method="post" action="/auth/pin" class="pin-keypad-form">
      <div id="pin-dots" class="pin-dots"></div>

      <input type="hidden" name="pin" id="pin-value">

      <div class="pin-keypad-grid">
        {% for n in [1,2,3,4,5,6,7,8,9] %}
        <button type="button" class="pin-key" data-key="{{ n }}">{{ n }}</button>
        {% endfor %}

        <button type="button" class="pin-key pin-key-action" data-action="clear">C</button>
        <button type="button" class="pin-key" data-key="0">0</button>
        <button type="button" class="pin-key pin-key-action" data-action="backspace">⌫</button>
      </div>

      <div class="pin-actions">
        <button type="button" class="btn pin-cancel" id="pin-cancel">Annulla</button>
        <button type="submit" class="btn btn-operator pin-ok">OK</button>
      </div>
    </form>
  </div>
</div>

<!-- OVERLAY AVVIO/ARRESTO LEZIONE -->
<div id="scene-overlay" class="scene-overlay hidden">
  <div class="scene-overlay-backdrop"></div>

  <div class="scene-overlay-dialog">
    <div class="scene-overlay-title" id="scene-overlay-title">
      Operazione in corso
    </div>
    <div class="scene-status-label" id="scene-status-label">
      Avvio/arresto in corso, attendere…
    </div>
  </div>
</div>

<script>
(function() {
  const MAX_LEN = 4; // porta a 6 se il PIN è a 6 cifre

  // === PIN OVERLAY ===
  const overlay   = document.getElementById('pin-overlay');
  const openBtn   = document.getElementById('open-pin-overlay');
  const cancelBtn = document.getElementById('pin-cancel');
  const pinValue  = document.getElementById('pin-value');
  const pinDots   = document.getElementById('pin-dots');
  const keys      = overlay ? overlay.querySelectorAll('.pin-key') : [];
  const backdrop  = overlay ? overlay.querySelector('.pin-overlay-backdrop') : null;

  function renderDots() {
    if (!pinDots || !pinValue) return;
    const len = (pinValue.value || '').length;
    pinDots.textContent = '●'.repeat(len);
  }

  function clearPin() {
    if (!pinValue) return;
    pinValue.value = '';
    renderDots();
  }

  function addDigit(d) {
    if (!pinValue) return;
    if (pinValue.value.length >= MAX_LEN) return;
    pinValue.value += d;
    renderDots();
  }

  function backspace() {
    if (!pinValue) return;
    pinValue.value = pinValue.value.slice(0, -1);
    renderDots();
  }

  function openPinOverlay() {
    if (!overlay) return;
    clearPin();
    overlay.classList.remove('hidden');
  }

  function closePinOverlay() {
    if (!overlay) return;
    overlay.classList.add('hidden');
    clearPin();
  }

  if (openBtn) {
    openBtn.addEventListener('click', openPinOverlay);
  }
  if (cancelBtn) {
    cancelBtn.addEventListener('click', closePinOverlay);
  }
  if (backdrop) {
    backdrop.addEventListener('click', closePinOverlay);
  }

  keys.forEach(btn => {
    btn.addEventListener('click', () => {
      const key = btn.dataset.key;
      const action = btn.dataset.action;
      if (key !== undefined) {
        addDigit(key);
      } else if (action === 'clear') {
        clearPin();
      } else if (action === 'backspace') {
        backspace();
      }
    });
  });

  document.addEventListener('contextmenu', e => e.preventDefault());

  // valore da Jinja: apre il PIN overlay se c'è stato errore
  const hasPinError = {{ 'true' if pin_error else 'false' }};
  if (hasPinError) {
    openPinOverlay();
  }

  // === OVERLAY AVVIO/ARRESTO LEZIONE ===
  const sceneOverlay       = document.getElementById('scene-overlay');
  const sceneStatusLabel   = document.getElementById('scene-status-label');
  const sceneOverlayTitle  = document.getElementById('scene-overlay-title');

  function openSceneOverlay(initialTitle, initialText) {
    if (!sceneOverlay) return;
    if (sceneOverlayTitle && initialTitle) {
      sceneOverlayTitle.textContent = initialTitle;
    }
    if (sceneStatusLabel && initialText) {
      sceneStatusLabel.textContent = initialText;
    }
    sceneOverlay.classList.remove('hidden');
  }

  // Aggancia tutte le form delle scene
  const sceneForms = document.querySelectorAll('form.scene-form');
  sceneForms.forEach(form => {
    form.addEventListener('submit', () => {
      const action = form.getAttribute('action') || '';
      let title = 'Operazione in corso';
      let text  = 'Avvio/arresto in corso, attendere…';

      if (action.includes('/ui/scene/avvio_semplice')) {
        title = 'Avvio Lezione Semplice';
        text  = 'Avvio lezione semplice in corso, attendere…';
      } else if (action.includes('/ui/scene/avvio_video_combinata')) {
        title = 'Avvio Lezione Video Combinata';
        text  = 'Avvio lezione video combinata in corso, attendere…';
      } else if (action.includes('/ui/scene/avvio_video')) {
        title = 'Avvio Lezione Video';
        text  = 'Avvio lezione video in corso, attendere…';
      } else if (action.includes('/ui/scene/spegni_aula')) {
        title = 'Fine Lezione – Spegni Aula';
        text  = 'Arresto lezione e spegnimento aula in corso, attendere…';
      }

      openSceneOverlay(title, text);
      // NON facciamo preventDefault: il submit continua normalmente,
      // il backend esegue la scena e poi fa redirect alla home,
      // facendo sparire l’overlay al reload.
    });
  });

})();
</script>
{% endblock %}
